#!/bin/sh -e

from_base="prx_apps"
from_bucket="${from_base}-secrets"

to_base="prx-infrastructure-us-east-1"
to_bucket="${from_base}-secrets"

secret_keys=`aws s3api list-objects-v2 --bucket ${from_bucket} --query "Contents[?contains(Key, 'secrets')] | [*].Key" --output text`
# echo $secret_keys
tmp=`mktemp -d 2>/dev/null || mktemp -d -t 'astmpdir'`
# echo $tmp
for sk in $secret_keys; do
  # echo $sk
  IFS='/'
  parts=($sk)
  app=${parts[0]}
  env=${parts[1]}
  unset IFS
  # echo "app ${app}, env ${env}"
  from_secrets_file=$tmp/${app}_${env}_secrets.txt
  aws-secrets-get ${app} current ${env} ${from_base} > ${from_secrets_file}
  aws-secrets-send ${app} ${from_secrets_file} ${env} ${to_base}
  # echo "----------"
done
